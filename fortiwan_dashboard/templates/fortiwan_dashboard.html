<!--Fetch_Layout File-->
{% extends 'base.html' %}

<!--Set Tab Title-->
{% block title %}Dashboard - Fortiwan{% endblock %}

{% block app_title %}Welcome to Fortiwan BCFA{% endblock %}

{% block app_subtitle %}A WebApp derived from the FortiOS REST API.{% endblock %}

{% block current_location %}Dashboard{% endblock %}

<!--Body Content-->
{% block content %}
<div class="row">
    <div class="col">
        <!-- Firewalls(w.Proxy Details) -->
        <div class="row g-2" id="ipsec-container">
            <div class="col-12">
                <p class="fs-2 fw-medium mb-0">Firewalls IP/Sec Overview</p>
                <p class="fs-5 ms-2 fw-light">Insights & Firewall's WAN Interface.</p>
                <form>
                    <div class="input-group">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="floatingInput"
                                placeholder="Search IPsec VPN Tunnels disabled">
                            <label for="floatingInput">Search IPsec Tunnels</label>
                        </div>
                        <button class="btn btn-outline-secondary" type="button" id="button-addon2">Go</button>
                    </div>
                </form>
                <div class="pt-2 pb-2">
                    <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown"
                        aria-expanded="false" disabled>SORT</button>
                </div>
            </div>
            <div id="spinner" class="spinner-border text-primary" role="status">
                <span class="sr-only"></span>
            </div>
            <!-- Firewall Template -->
            <div class="col-md-6 col-12" id="template" hidden>
                <div class="card w-100">
                    <div class="card-body">
                        <div class="container">
                            <div class="row">
                                <div class="col-12">
                                    <h5 class="card-title" id="ipsec-name"></h5>
                                    <div class="badge bg-success rounded-pill" id="ipsec-status"></div>
                                    <hr>
                                </div>
                                <div class="col-md-6 col-12">
                                    <p class="card-text">
                                    <h6 class="fs-6 fw-semibold mb-0">IPv4 Address:</h6>
                                    <p class="fs-6 fw-light ms-2" id="ipsec-ip"></p>
                                    </p>
                                </div>
                                <div class="col-md-6 col-12">
                                    <p class="card-text">
                                        <h6 class="fw-semibold mb-0">WAN Interface:</h6>
                                        <p class="text-warning" id="no-interface"><small><em>NO INTERFACE</em></small></p>
                                        <p class="text-success fw-light" id="has-interface"></p>
                                    </p>
                                </div>
                                <div class="col-md-6 col-12">
                                    <hr>
                                    <h6 class="fw-semibold mb-0">CORE TRAFFIC</h6>
                                    <p class="fs-6 mb-0 ms-2 fw-light"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload" viewBox="0 0 16 16">
                                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
                                        <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/>
                                      </svg> <span id="ipsec-incoming-core"></span> MB/s</p>
                                    <p class="fs-6 mb-0 ms-2 fw-light"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
                                        <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                                      </svg> <span id="ipsec-outgoing-core"></span> MB/s</p>
                                </div>
                                <div class="col-md-6 col-12">
                                    <hr>
                                    <h6 class="fw-semibold mb-0">TUNNEL TRAFFIC</h6>
                                    <p class="fs-6 mb-0 ms-2 fw-light"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload" viewBox="0 0 16 16">
                                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
                                        <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/>
                                      </svg> <span id="ipsec-incoming-tunnel"></span> MB/s</p>
                                    <p class="fs-6 mb-0 ms-2 fw-light"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
                                        <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                                      </svg> <span id="ipsec-outgoing-tunnel"></span> MB/s</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer" id="card-footer"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col"></div>
</div>
<div id="modal-container">

</div>
<!-- Button trigger modal -->
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#interface-modal" id="launch-modal" hidden></button>  

<div id="modal-template">    
    <!-- Modal -->
    <div class="modal fade" tabindex="-1" aria-labelledby="modal-title" aria-hidden="true" id="interface-modal">
        <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
            <h1 class="modal-title fs-5" id="modal-title"></h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="modal-close"></button>
            </div>
            <div class="modal-body">
                <p class="fs-6 fw-bolder text-warning" id="interface-desc"></p>
            </div>
            <div class="modal-footer">
            <button type="submit" class="btn btn-success" id="modal-save" hidden>Confirm Switch</button>
            <form action="{% url 'fortiwan_config:put_interface' %}" method="post">
                {% csrf_token %}

                <label class="form-label" for="name">Name</label>
                <input type="text" class="form-control disabled" aria-describedby="name" name="name" placeholder="non" value="" id="input-interface-name" required>

                <label class="form-label" for="interface">Interface</label>
                <input type="text" class="form-control disabled" aria-describedby="interface" name="interface" placeholder="non" value="" id="input-interface" required>

                <input type="submit" class="btn btn-success" value="Confirm">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal" id="modal-cancel">Cancel</button>
            </form>            
            </div>
        </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
     function confirmSwitch(name, interface) {
        const csrftoken = getCookie('csrftoken'); 
        // Perform AJAX request with the modalName as a parameter
        $.ajax({
            url: '{% url "fortiwan_config:put_interface" %}',
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
            },
            data: {
                // Include any data you want to send with the request
                name: name,
                interface: interface,
            },
            success: function (response) {
                // Handle the successful response here
                console.log(`AJAX request successful for ${modalName}:`, response);
            },
            error: function (error) {
                // Handle errors here
                console.error(`AJAX request failed for ${modalName}:`, error);
            }
        });
    }
    $(document).ready(function () {
        // Show spinner initially
        $('#spinner').show();
        $('#has-interface').hide();

        // Fetch data from the server using AJAX
        $.ajax({
            url: '{% url "fortiwan_monitor:fetch_tunnels" %}',
            type: 'GET',
            dataType: 'json',
            success: function (dataList) {
                // Hide spinner on success and display data
                $('#spinner').hide();

                // var sortedDataList = Object.entries(dataList).sort((a, b) => b[1].vpn_tunnel - a[1].vpn_tunnel);

                // Loop through the list of VPN tunnels
                $.each(dataList, function (index, data) {
                    // Clone the template for each VPN tunnel
                    var $template = $('#template').clone();
      
                    $template.find('#ipsec-name').text(data.name + ' | ' + data.comment);

                    $template.find('#ipsec-status').text('STATUS ' + data.status.toUpperCase());

                    $template.find('#ipsec-ip').text(data.ip);

                    $template.find('#ipsec-incoming-core').text(data.incoming_core);
                    $template.find('#ipsec-incoming-tunnel').text(data.incoming_tunnel);

                    $template.find('#ipsec-outgoing-core').text(data.outgoing_core);
                    $template.find('#ipsec-outgoing-tunnel').text(data.outgoing_tunnel);

                    var wan_interface = data.interface;                    
                    console.log(wan_interface);

                    if (wan_interface == 'ECHO') {
                        $template.find('#has-interface').text('ECHO').show();          
                        $template.find('#no-interface').hide();

                        var $modal = $('#modal-template').clone();

                        var interface_modal_id = 'interface-modal-' + data.name.toLowerCase();

                        $modal.find('#interface-modal').attr('id', interface_modal_id);
                        $modal.find('#modal-title').text('Switch to MTN Interface?');
                        $modal.find('#interface-desc').text('Are you sure you want switch ' + data.name + ' from ECHO to MTN');


                        var $launch_modal = $('#launch-modal').clone();

                        $launch_modal.attr('data-bs-target', '#' + interface_modal_id);
                        $launch_modal.attr('title', interface_modal_id + '-title');
                        $launch_modal.text('Switch Interfaces').removeAttr('hidden');
                        $launch_modal.attr('id', interface_modal_id + '-launch-modal');

                        $template.find('#card-footer').append($launch_modal);

                        $modal.find('#modal-save').attr('onclick', "confirmSwitch('" + data.name + "', '" + wan_interface + "')")
                        
                        // $modal.find('#modal-form').attr('action', '{% url "fortiwan_config:put_interface" %}')
                        $modal.find('#input-interface-name').attr('value', data.name)
                        $modal.find('#input-interface').attr('value', wan_interface)

                        $('#modal-container').append($modal);

                    } else if (wan_interface == 'MTN') {
                        $template.find('#has-interface').text('MTN').show();          
                        $template.find('#no-interface').hide();

                        var $modal = $('#modal-template').clone();

                        var interface_modal_id = 'interface-modal-' + data.name.toLowerCase();

                        $modal.find('#interface-modal').attr('id', interface_modal_id);
                        $modal.find('#modal-title').text('Switch to ECHO Interface?');
                        $modal.find('#interface-desc').text('Are you sure you want switch <b>' + data.name + '</b> from MTN to ECHO');

                        var $launch_modal = $('#launch-modal').clone();

                        $launch_modal.attr('data-bs-target', '#' + interface_modal_id);
                        $launch_modal.attr('title', interface_modal_id + '-title');
                        $launch_modal.text('Switch Interfaces').removeAttr('hidden');
                        $launch_modal.attr('id', interface_modal_id + '-launch-modal');                        

                        $template.find('#card-footer').append($launch_modal);
                        $modal.find('#modal-save').attr('onclick', "confirmSwitch('" + data.name + "', '" + wan_interface + "')")

                        $('#modal-container').append($modal);
                    } else {
                        $template.find('#no-interface').show();
                        $template.find('#edit-model-btn').addClass('disabled');
                    }

                    // Remove the hidden Attribute for VPN/IPsec Tunnel
                    $template.removeAttr('hidden');

                    // Populate VPN/IPsec Container
                    $('#ipsec-container').append($template);
                });
            
            },
            error: function () {
                // Handle errors if necessary
                console.error('Error fetching data from the server');
            }
        });      
    });
</script>
{% endblock javascript %}